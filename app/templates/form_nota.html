<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Formulário de Nota Técnica</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f9f9f9;
        }
        h2, h3 {
            color: #333;
        }
        fieldset {
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 30px;
            background-color: #fff;
        }
        legend {
            font-weight: bold;
            padding: 0 10px;
        }
        label {
            display: block;
            margin-top: 10px;
        }
        input[type="text"],
        input[type="date"],
        input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            box-sizing: border-box;
        }
        input[readonly] {
            background-color: #eee;
        }
        button {
            padding: 10px 20px;
            background-color: #0066cc;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #004c99;
        }
    </style>
</head>
<body>

<h2>Emissão de Nota Técnica de Recesso</h2>

<form action="/nota-tecnica/gerar" method="post">

    <!-- ============================
         DADOS DO ESTAGIÁRIO
    ============================ -->
    <fieldset>
        <legend>Dados do Estagiário(a)</legend>

        <label>Nome:</label>
        <input type="text" name="nome" required>

        <label>Ocupação:</label>
        <input type="text" name="ocupacao" required>

        <label>Matrícula:</label>
        <input type="text" name="matricula" required>

        <label>Processo PAE:</label>
        <input type="text" name="processo_pae" required>

        <label>Assunto:</label>
        <input type="text" name="assunto" value="Pagamento de Recesso Não Usufruído">
    </fieldset>

    <!-- ============================
         DADOS DO CONTRATO
    ============================ -->
    <fieldset>
        <legend>Dados do Contrato</legend>

        <label>Início:</label>
        <input type="date" name="inicio" required>

        <label>Encerramento:</label>
        <input type="date" name="fim" required>

        <label>Dias de Contrato:</label>
        <input type="number" name="dias_contrato" readonly>
    </fieldset>

    <!-- ============================
         PERÍODO AQUISITIVO
    ============================ -->
    <fieldset>
        <legend>Período Aquisitivo de Recesso</legend>

        <h3>1° Ciclo</h3>
        <label>Início:</label>
        <input type="date" name="ciclo1_inicio" readonly>

        <label>Final:</label>
        <input type="date" name="ciclo1_fim" readonly>

        <label>Contagem de Dias:</label>
        <input type="number" name="ciclo1_dias" readonly>

        <h3>2° Ciclo</h3>
        <label>Início:</label>
        <input type="date" name="ciclo2_inicio" readonly>

        <label>Final:</label>
        <input type="date" name="ciclo2_fim" readonly>

        <label>Contagem de Dias:</label>
        <input type="number" name="ciclo2_dias" readonly>
    </fieldset>

    <!-- ============================
         PERÍODO DE GOZO
    ============================ -->
    <fieldset>
        <legend>Período de Gozo de Recesso</legend>

        <h3>1° Ciclo</h3>
        <label>Direito de Gozo:</label>
        <input type="number" name="ciclo1_direito" readonly>

        <label>Usufruídos:</label>
        <input type="number" name="ciclo1_gozados" min="0" value="0" required>

        <label>Não Usufruídos:</label>
        <input type="number" name="ciclo1_nao_gozados" readonly>

        <h3>2° Ciclo</h3>
        <label>Direito de Gozo:</label>
        <input type="number" name="ciclo2_direito" readonly>

        <label>Usufruídos:</label>
        <input type="number" name="ciclo2_gozados" min="0" value="0" required>

        <label>Não Usufruídos:</label>
        <input type="number" name="ciclo2_nao_gozados" readonly>
    </fieldset>

    <button type="submit">Gerar Nota Técnica</button>
</form>

<!-- ============================================================
     SCRIPT COMPLETO (MÁSCARAS + CÁLCULOS AUTOMÁTICOS)
============================================================ -->
<script>

 /* ============================
   MÁSCARA: MATRÍCULA
   Regras:
   - Só números e "/"
   - Apenas uma "/"
   - Máx. 2 dígitos após a "/"
============================ */
function mascaraMatricula() {
    const campo = document.querySelector("[name='matricula']");
    let v = campo.value;

    // Remove tudo que não for número ou "/"
    v = v.replace(/[^0-9/]/g, "");

    // Garante que só exista UMA barra
    const partes = v.split("/");
    const antes = partes[0].replace(/\D/g, ""); // só números antes da barra
    let depois = partes[1] ? partes[1].replace(/\D/g, "") : "";

    // Limita a 2 dígitos após a barra
    depois = depois.slice(0, 2);

    // Remonta o valor final
    v = depois.length > 0 ? `${antes}/${depois}` : antes;

    campo.value = v;
}

document.querySelector("[name='matricula']")
    .addEventListener("input", mascaraMatricula);

    /* ============================
       MÁSCARA: PROCESSO PAE
    ============================ */
    function mascaraProcesso() {
        const campo = document.querySelector("[name='processo_pae']");
        let v = campo.value.replace(/\D/g, "");

        if (v.length > 4) {
            v = v.slice(0, 4) + "/" + v.slice(4, 14);
        }

        campo.value = v;
    }

    document.querySelector("[name='processo_pae']")
        .addEventListener("input", mascaraProcesso);


    /* ============================
       FUNÇÕES DE CÁLCULO
    ============================ */

    function parseDate(value) {
        return value ? new Date(value + "T00:00:00") : null;
    }

    function diffDays(inicio, fim) {
        return Math.floor((fim - inicio) / (1000 * 60 * 60 * 24));
    }

    function calcularDireito(dias) {
        if (dias < 180) return 0;
        if (dias === 180) return 15;
        if (dias <= 210) return 18;
        if (dias <= 240) return 20;
        if (dias <= 270) return 23;
        if (dias <= 300) return 25;
        if (dias <= 330) return 28;
        if (dias <= 366) return 30;
        return 0;
    }

    function atualizarCiclos() {
        const inicio = parseDate(document.querySelector("[name='inicio']").value);
        const fim = parseDate(document.querySelector("[name='fim']").value);

        if (!inicio || !fim) return;

        const diasContrato = diffDays(inicio, fim);
        document.querySelector("[name='dias_contrato']").value = diasContrato;

        let ciclo1_inicio = inicio;
        let ciclo1_fim;
        let ciclo2_inicio = null;
        let ciclo2_fim = null;

        if (diasContrato < 364) {
            ciclo1_fim = fim;
        } else {
            ciclo1_fim = new Date(inicio);
            ciclo1_fim.setDate(ciclo1_fim.getDate() + 364);

            ciclo2_inicio = new Date(ciclo1_fim);
            ciclo2_inicio.setDate(ciclo2_inicio.getDate() + 1);

            ciclo2_fim = fim;
        }

        document.querySelector("[name='ciclo1_inicio']").value = ciclo1_inicio.toISOString().slice(0, 10);
        document.querySelector("[name='ciclo1_fim']").value = ciclo1_fim.toISOString().slice(0, 10);

        const diasCiclo1 = diffDays(ciclo1_inicio, ciclo1_fim);
        document.querySelector("[name='ciclo1_dias']").value = diasCiclo1;

        const direito1 = calcularDireito(diasCiclo1);
        document.querySelector("[name='ciclo1_direito']").value = direito1;

        if (ciclo2_inicio && ciclo2_fim) {
            document.querySelector("[name='ciclo2_inicio']").value = ciclo2_inicio.toISOString().slice(0, 10);
            document.querySelector("[name='ciclo2_fim']").value = ciclo2_fim.toISOString().slice(0, 10);

            const diasCiclo2 = diffDays(ciclo2_inicio, ciclo2_fim);
            document.querySelector("[name='ciclo2_dias']").value = diasCiclo2;

            const direito2 = calcularDireito(diasCiclo2);
            document.querySelector("[name='ciclo2_direito']").value = direito2;
        } else {
            document.querySelector("[name='ciclo2_inicio']").value = "";
            document.querySelector("[name='ciclo2_fim']").value = "";
            document.querySelector("[name='ciclo2_dias']").value = "";
            document.querySelector("[name='ciclo2_direito']").value = "";
        }

        atualizarNaoUsufruidos();
    }

    function atualizarNaoUsufruidos() {
        const direito1 = Number(document.querySelector("[name='ciclo1_direito']").value || 0);
        const gozados1 = Number(document.querySelector("[name='ciclo1_gozados']").value || 0);
        document.querySelector("[name='ciclo1_nao_gozados']").value = Math.max(direito1 - gozados1, 0);

        const direito2 = Number(document.querySelector("[name='ciclo2_direito']").value || 0);
        const gozados2 = Number(document.querySelector("[name='ciclo2_gozados']").value || 0);
        document.querySelector("[name='ciclo2_nao_gozados']").value = Math.max(direito2 - gozados2, 0);
    }

    document.querySelector("[name='inicio']").addEventListener("change", atualizarCiclos);
    document.querySelector("[name='fim']").addEventListener("change", atualizarCiclos);

    document.querySelector("[name='ciclo1_gozados']").addEventListener("input", atualizarNaoUsufruidos);
    document.querySelector("[name='ciclo2_gozados']").addEventListener("input", atualizarNaoUsufruidos);

</script>

</body>
</html>
